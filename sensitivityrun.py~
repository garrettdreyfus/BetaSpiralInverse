from regionlib import brasil
import os, gsw
import pickle
import graph, nstools, interptools, inverttools
from functools import partial
import parametertools as ptools
import numpy as np
import matplotlib.pyplot as plt
import seaborn as sns
import pdb
from scipy.io import savemat
import sensitivity

### REFERENCE LEVEL TESTING 
################### SAVE WITH DIFFERENT REF LEVELS
with open('data/withparams.pickle', 'rb') as outfile:
    [surfaces,neighbors,distances] = pickle.load(outfile)
#graph.graphSurfaces(brasil,surfaces,"psi",stds=1,show=True,select=range(3000,5000))
reflevels = surfaces.keys()
levels = []
hunters = []
vemas = []
conditions=[]
curls = []
errors = []
for k in reflevels:
    if int(k) >1200 and int(k) < 4000:
        with open('data/withparams.pickle', 'rb') as outfile:
            [surfaces,neighbors,distances] = pickle.load(outfile)
        params = {"reflevel":int(k),"upperbound":1000,"lowerbound":4000,\
                "mixs":{"kvo":True,"kvb":True,"kh":True},"debug":False,\
                  "3point":True,"edgeguard":True,"H_0":1000}
        out= inverttools.invert("coupled",surfaces,neighbors,distances,params=params)

        inv = out["surfaces"]
        inv = nstools.streamFuncToUV(inv,neighbors,distances)
        # graph.graphVectorField(brasil,inv,"uabs","vabs","pres",# \
        #                         metadata=out["metadata"],select=[3600],\
        #                         transform=False,show=False,scale=0.1,\
        #                         savepath="../articcirc-pics/vectorfields/curls/"+str(k))

        with open('data/reflevelchoice/{}.pickle'.format(k), 'wb') as outfile:
            [out,neighbors,distances] = pickle.load(outfile)
        levels.append(k)
        result = nstools.transportDiagnostics(inv)
        hunters.append(result["hunter"])
        vemas.append(result["vema"])
        curls.append(result["curl"])
        conditions.append(out["metadata"]["condition"])
        errors.append(out["metadata"]["error"])
fig,((ax1,ax2,ax3),(ax4,ax5,ax6)) = plt.subplots(2,3)
ax1.plot(levels,conditions)
ax2.plot(levels,errors)
ax4.plot(levels,vemas)
ax5.plot(levels,hunters)
ax6.plot(levels,curls)
plt.show()



################### PLOT DIFFERENT REF LEVELS
with open('data/interpedbrasil.pickle', 'rb') as outfile:
    [surfaces,neighbors,distances] = pickle.load(outfile)
levels = surfaces.keys()
for k in levels:
    if int(k) >1000 and int(k) < 4000:
        with open('data/reflevelchoice/{}.pickle'.format(k), 'rb') as outfile:
            [out,neighbors,distances] = pickle.load(outfile)
        inv = out["surfaces"]
        inv = nstools.streamFuncToUV(inv,neighbors,distances)
        graph.graphVectorField(brasil,inv,"uabs","vabs","pres",# \
                                metadata=out["metadata"],\
                                transform=False,show=False,
                                savepath="../articcirc-pics/vectorfields/reflevelchoice/{}".format(k),scale=0.1)



